name: Web Calculator CI/CD

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GITHUB_USERNAME: ${{ github.repository_owner }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run unit tests with pytest
      run: |
        python -m pytest tests/unit_tests/ -v \
          --junitxml=junit-unit-${{ matrix.python-version }}.xml \
          --cov=calculator \
          --cov-report=xml
    
    - name: Run functional tests
      run: |
        # ÂêØÂä®Â∫îÁî®
        python app.py &
        APP_PID=$!
        
        # Á≠âÂæÖÂ∫îÁî®ÂêØÂä®
        echo "Waiting for app to start..."
        sleep 10
        
        # Ê£ÄÊü•Â∫îÁî®ÊòØÂê¶ËøêË°å
        if ! ps -p $APP_PID > /dev/null; then
          echo "‚ùå Application failed to start"
          exit 1
        fi
        
        # ËøêË°åÂäüËÉΩÊµãËØï
        python -m pytest tests/functional_tests/ -v \
          --junitxml=junit-func-${{ matrix.python-version }}.xml
        
        # ÂÅúÊ≠¢Â∫îÁî®
        echo "Stopping application..."
        kill $APP_PID || true
        wait $APP_PID 2>/dev/null || true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          junit-*.xml
          coverage.xml
        retention-days: 7

  build:
    name: Build and Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/'))
  
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}
    
    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=sha,prefix={{branch}}-,format=short
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          GIT_COMMIT=${{ github.sha }}
    
    - name: Verify pushed image
      if: success() && github.event_name != 'pull_request'
      run: |
        echo "‚úÖ Docker image pushed successfully"
        echo "Tags: ${{ steps.meta.outputs.tags }}"

  deploy:
    name: Blue-Green Deployment
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: http://localhost

    
    steps:
    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass netcat-openbsd
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate deployment tag
      id: vars
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "DEPLOY_TAG=sha-$SHORT_SHA" >> $GITHUB_ENV
        echo "IMAGE_FULL_NAME=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-$SHORT_SHA" >> $GITHUB_ENV
  
    - name: Prepare deployment script
      run: |
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "========================================="
        echo "Starting blue-green deployment"
        echo "========================================="
        echo "Image: ${{ env.IMAGE_FULL_NAME }}"
        echo "Deploy tag: ${{ env.DEPLOY_TAG }}"
        echo "Timestamp: $(date)"
        
        cd /opt/web-calculator
        
        # Ê£ÄÊü•ÂΩìÂâçÊ¥ªÂä®È¢úËâ≤
        CURRENT_COLOR=""
        NEXT_COLOR=""
        
        if docker-compose ps app_blue 2>/dev/null | grep -q "Up" && \
           grep -q "app_blue.*max_fails" nginx/conf.d/default.conf 2>/dev/null; then
          CURRENT_COLOR="blue"
          NEXT_COLOR="green"
        elif docker-compose ps app_green 2>/dev/null | grep -q "Up" && \
             grep -q "app_green.*max_fails" nginx/conf.d/default.conf 2>/dev/null; then
          CURRENT_COLOR="green"
          NEXT_COLOR="blue"
        else
          # Â¶ÇÊûúÈÉΩÊú™ËøêË°åÔºå‰ªéblueÂºÄÂßã
          CURRENT_COLOR="none"
          NEXT_COLOR="blue"
        fi
        
        echo "Current active: $CURRENT_COLOR"
        echo "Deploying to: $NEXT_COLOR"
        
        # Êõ¥Êñ∞ÁéØÂ¢ÉÂèòÈáè
        echo "GITHUB_USERNAME=${{ env.GITHUB_USERNAME }}" > .env
        if [ "$NEXT_COLOR" = "blue" ]; then
          echo "BLUE_TAG=${{ env.DEPLOY_TAG }}" >> .env
          echo "GREEN_TAG=latest" >> .env
        else
          echo "BLUE_TAG=latest" >> .env
          echo "GREEN_TAG=${{ env.DEPLOY_TAG }}" >> .env
        fi
        
        # ÊãâÂèñÊñ∞ÈïúÂÉè
        echo "--------------------------------------------------"
        echo "Pulling new image for $NEXT_COLOR..."
        docker-compose pull app_${NEXT_COLOR} || {
          echo "‚ùå Failed to pull image"
          exit 1
        }
        
        # ÂêØÂä®Êñ∞ÁâàÊú¨
        echo "--------------------------------------------------"
        echo "Starting new $NEXT_COLOR version..."
        docker-compose up -d app_${NEXT_COLOR} || {
          echo "‚ùå Failed to start container"
          exit 1
        }
        
        # Á≠âÂæÖÂÅ•Â∫∑Ê£ÄÊü•
        echo "--------------------------------------------------"
        echo "Waiting for health check..."
        MAX_RETRIES=30
        HEALTHY=false
        
        for i in $(seq 1 $MAX_RETRIES); do
          if docker-compose ps app_${NEXT_COLOR} 2>/dev/null | grep -q "(healthy)"; then
            HEALTHY=true
            echo "‚úÖ New version is healthy"
            break
          fi
          
          # Ê£ÄÊü•ÂÆπÂô®ÊòØÂê¶‰ªçÂú®ËøêË°å
          if ! docker-compose ps app_${NEXT_COLOR} 2>/dev/null | grep -q "Up"; then
            echo "‚ùå Container stopped unexpectedly"
            docker-compose logs app_${NEXT_COLOR} || true
            exit 1
          fi
          
          echo "Attempt $i/$MAX_RETRIES: Waiting for health check..."
          sleep 2
        done
        
        if [ "$HEALTHY" = false ]; then
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          docker-compose logs app_${NEXT_COLOR} || true
          exit 1
        fi
        
        # ÂàáÊç¢ÊµÅÈáè
        echo "--------------------------------------------------"
        echo "Switching traffic to $NEXT_COLOR..."
        
        if [ "$NEXT_COLOR" = "green" ]; then
          # ‰ªéblueÂàáÊç¢Âà∞green
          sed -i 's/server app_blue:5000 max_fails=1 fail_timeout=5s;/server app_blue:5000;/' nginx/conf.d/default.conf
          sed -i 's/server app_green:5000;/server app_green:5000 max_fails=1 fail_timeout=5s;/' nginx/conf.d/default.conf
        else
          # ‰ªégreenÂàáÊç¢Âà∞blue
          sed -i 's/server app_green:5000 max_fails=1 fail_timeout=5s;/server app_green:5000;/' nginx/conf.d/default.conf
          sed -i 's/server app_blue:5000;/server app_blue:5000 max_fails=1 fail_timeout=5s;/' nginx/conf.d/default.conf
        fi
        
        # ÈáçÊñ∞Âä†ËΩΩNginx
        echo "Reloading nginx..."
        docker-compose exec -T proxy nginx -s reload || {
          echo "‚ùå Failed to reload nginx"
          exit 1
        }
        
        # ÂÅúÊ≠¢ÊóßÁâàÊú¨ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
        if [ "$CURRENT_COLOR" != "none" ]; then
          echo "--------------------------------------------------"
          echo "Stopping old $CURRENT_COLOR version in 30 seconds..."
          (sleep 30 && echo "Stopping old version..." && docker-compose stop app_${CURRENT_COLOR} 2>/dev/null || true) &
        fi
        
        # È™åËØÅÈÉ®ÁΩ≤
        echo "--------------------------------------------------"
        echo "Verifying deployment..."
        
        sleep 5  # Áªônginx‰∏Ä‰∫õÊó∂Èó¥
        
        MAX_VERIFY_RETRIES=10
        VERIFIED=false
        
        for i in $(seq 1 $MAX_VERIFY_RETRIES); do
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://localhost/health 2>/dev/null || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            VERIFIED=true
            break
          fi
          
          echo "Verification attempt $i/$MAX_VERIFY_RETRIES: HTTP $RESPONSE"
          sleep 2
        done
        
        if [ "$VERIFIED" = true ]; then
          echo "========================================="
          echo "‚úÖ Deployment successful!"
          echo "Active version: $NEXT_COLOR"
          echo "========================================="
        else
          echo "‚ùå Deployment verification failed"
          echo "Last response code: $RESPONSE"
          exit 1
        fi
        EOF
        
        chmod +x deploy.sh
        echo "‚úÖ Deployment script created"
    
    - name: Test SSH connection with retry
      id: ssh-test
      timeout-minutes: 2
      env:
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        VM_USER: ${{ secrets.VM_USER || 'ubuntu' }}
        VM_HOST: ${{ secrets.VM_HOST }}
      run: |
        echo "Testing SSH connection to $VM_USER@$VM_HOST..."
        
        # ÂÖàÊ£ÄÊü•Á´ØÂè£ÊòØÂê¶ÂºÄÊîæ
        echo "Checking if port 22 is open on $VM_HOST..."
        if ! nc -z -w 5 "$VM_HOST" 22; then
          echo "‚ùå Port 22 is not open on $VM_HOST"
          echo "Please check firewall rules and VM network settings"
          exit 1
        fi
        
        echo "‚úÖ Port 22 is open"
        
        # Â∏¶ÈáçËØïÁöÑSSHËøûÊé•ÊµãËØï
        MAX_RETRIES=3
        RETRY_DELAY=10
        
        for i in $(seq 1 $MAX_RETRIES); do
          echo "SSH connection attempt $i/$MAX_RETRIES..."
          
          # ÊµãËØïËøûÊé•
          timeout 30s sshpass -p "$VM_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            -o BatchMode=yes \
            -o UserKnownHostsFile=/dev/null \
            "$VM_USER@$VM_HOST" \
            "echo 'SSH connection successful'; hostname; whoami; date" && {
              echo "‚úÖ SSH connection successful"
              exit 0
            }
          
          SSH_EXIT_CODE=$?
          
          if [ $i -lt $MAX_RETRIES ]; then
            echo "SSH connection failed (exit code: $SSH_EXIT_CODE), retrying in $RETRY_DELAY seconds..."
            sleep $RETRY_DELAY
          else
            echo "‚ùå SSH connection failed after $MAX_RETRIES attempts"
            echo "Last exit code: $SSH_EXIT_CODE"
            echo "Please check:"
            echo "1. VM credentials (username/password)"
            echo "2. VM network connectivity"
            echo "3. SSH service status on VM"
            exit 1
          fi
        done
    
    - name: Create remote directory structure
      env:
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        VM_USER: ${{ secrets.VM_USER || 'ubuntu' }}
        VM_HOST: ${{ secrets.VM_HOST }}
      run: |
        echo "Creating directory structure on VM..."
        
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=15 \
          "$VM_USER@$VM_HOST" \
          "sudo mkdir -p /opt/web-calculator/nginx/conf.d && \
           sudo chown -R $VM_USER:$VM_USER /opt/web-calculator && \
           echo '‚úÖ Directory created:' && \
           ls -la /opt/"
        
        echo "‚úÖ Directory structure created successfully"
    
    - name: Copy files to VM
      timeout-minutes: 5
      env:
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        VM_USER: ${{ secrets.VM_USER || 'ubuntu' }}
        VM_HOST: ${{ secrets.VM_HOST }}
      run: |
        set -e  # Âá∫ÈîôÊó∂ÂÅúÊ≠¢ÊâßË°å
        
        echo "Copying files to VM..."
        
        # Â§çÂà∂ÈÉ®ÁΩ≤ËÑöÊú¨
        echo "1. Copying deploy.sh..."
        sshpass -p "$VM_PASSWORD" scp \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=15 \
          -o BatchMode=yes \
          deploy.sh \
          "$VM_USER@$VM_HOST:/tmp/deploy.sh"
        
        # Â§çÂà∂ docker-compose.yml
        echo "2. Copying docker-compose.yml..."
        sshpass -p "$VM_PASSWORD" scp \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=15 \
          -o BatchMode=yes \
          docker-compose.yml \
          "$VM_USER@$VM_HOST:/opt/web-calculator/docker-compose.yml"
        
        # Â§çÂà∂ nginx ÈÖçÁΩÆ
        echo "3. Copying nginx configuration..."
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          "$VM_USER@$VM_HOST" \
          "mkdir -p /opt/web-calculator/nginx/conf.d"
        
        sshpass -p "$VM_PASSWORD" scp \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=15 \
          -o BatchMode=yes \
          nginx/conf.d/default.conf \
          "$VM_USER@$VM_HOST:/opt/web-calculator/nginx/conf.d/default.conf"
        
        # È™åËØÅÊñá‰ª∂Â§çÂà∂ÊàêÂäü
        echo "4. Verifying file transfer..."
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          "$VM_USER@$VM_HOST" \
          "echo '=== File listing ===' && \
           ls -la /opt/web-calculator/ && \
           echo '=== Nginx config ===' && \
           ls -la /opt/web-calculator/nginx/conf.d/ && \
           echo '=== Deploy script ===' && \
           ls -la /tmp/deploy.sh && \
           echo '=== File contents check ===' && \
           head -5 /tmp/deploy.sh && \
           echo '...'"
        
        echo "‚úÖ All files copied successfully"
    
    - name: Execute deployment
      env:
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        VM_USER: ${{ secrets.VM_USER || 'ubuntu' }}
        VM_HOST: ${{ secrets.VM_HOST }}
      run: |
        echo "Executing deployment script on VM..."
        
        # ËÆæÁΩÆÈÉ®ÁΩ≤Êó•ÂøóÊñá‰ª∂
        DEPLOY_LOG="/tmp/deployment-$(date +%Y%m%d-%H%M%S).log"
        
        # ÊâßË°åÈÉ®ÁΩ≤ËÑöÊú¨Âπ∂ÊçïËé∑ËæìÂá∫
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=30 \
          -o ServerAliveInterval=60 \
          -o ServerAliveCountMax=3 \
          "$VM_USER@$VM_HOST" \
          "echo 'Starting deployment at $(date)' && \
           cd /opt/web-calculator && \
           bash /tmp/deploy.sh 2>&1 | tee $DEPLOY_LOG && \
           echo 'Deployment completed at $(date)' || \
           (echo 'Deployment failed at $(date)'; cat $DEPLOY_LOG; exit 1)"
        
        echo "‚úÖ Deployment executed successfully"
    
    - name: Create and copy rollback script
      env:
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        VM_USER: ${{ secrets.VM_USER || 'ubuntu' }}
        VM_HOST: ${{ secrets.VM_HOST }}
      run: |
        echo "Creating rollback script..."
        
        cat > rollback.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "========================================="
        echo "Starting rollback procedure"
        echo "========================================="
        echo "Timestamp: $(date)"
        
        cd /opt/web-calculator
        
        # Ê£ÄÊü•ÂΩìÂâçÊ¥ªÂä®È¢úËâ≤
        CURRENT=""
        PREVIOUS=""
        
        if grep -q "app_blue.*max_fails" nginx/conf.d/default.conf 2>/dev/null; then
          CURRENT="blue"
          PREVIOUS="green"
        elif grep -q "app_green.*max_fails" nginx/conf.d/default.conf 2>/dev/null; then
          CURRENT="green"
          PREVIOUS="blue"
        else
          echo "‚ùå Cannot determine current active color"
          echo "Nginx config:"
          cat nginx/conf.d/default.conf || true
          exit 1
        fi
        
        echo "Current active: $CURRENT"
        echo "Rolling back to: $PREVIOUS"
        
        # Ê£ÄÊü•ÁõÆÊ†áÂÆπÂô®ÊòØÂê¶Â≠òÂú®‰∏îÂÅ•Â∫∑
        echo "--------------------------------------------------"
        echo "Checking $PREVIOUS container status..."
        
        if docker-compose ps app_${PREVIOUS} 2>/dev/null | grep -q "Up"; then
          echo "‚úÖ $PREVIOUS container is running"
        else
          echo "‚ö†Ô∏è $PREVIOUS container is not running, attempting to start..."
          docker-compose start app_${PREVIOUS} || {
            echo "‚ùå Failed to start $PREVIOUS container"
            exit 1
          }
          
          # Á≠âÂæÖÂêØÂä®
          sleep 5
        fi
        
        # ÂàáÊç¢ÊµÅÈáè
        echo "--------------------------------------------------"
        echo "Switching traffic from $CURRENT to $PREVIOUS..."
        
        if [ "$PREVIOUS" = "green" ]; then
          # ‰ªéblueÂàáÊç¢Âõûgreen
          sed -i 's/server app_blue:5000 max_fails=1 fail_timeout=5s;/server app_blue:5000;/' nginx/conf.d/default.conf
          sed -i 's/server app_green:5000;/server app_green:5000 max_fails=1 fail_timeout=5s;/' nginx/conf.d/default.conf
        else
          # ‰ªégreenÂàáÊç¢Âõûblue
          sed -i 's/server app_green:5000 max_fails=1 fail_timeout=5s;/server app_green:5000;/' nginx/conf.d/default.conf
          sed -i 's/server app_blue:5000;/server app_blue:5000 max_fails=1 fail_timeout=5s;/' nginx/conf.d/default.conf
        fi
        
        # ÈáçÊñ∞Âä†ËΩΩNginx
        echo "Reloading nginx..."
        docker-compose exec -T proxy nginx -s reload || {
          echo "‚ùå Failed to reload nginx"
          exit 1
        }
        
        # È™åËØÅÂõûÊªö
        echo "--------------------------------------------------"
        echo "Verifying rollback..."
        
        sleep 3
        
        MAX_VERIFY_RETRIES=5
        for i in $(seq 1 $MAX_VERIFY_RETRIES); do
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://localhost/health 2>/dev/null || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "========================================="
            echo "‚úÖ Rollback successful!"
            echo "Active version: $PREVIOUS"
            echo "========================================="
            exit 0
          fi
          
          echo "Verification attempt $i/$MAX_VERIFY_RETRIES: HTTP $RESPONSE"
          sleep 2
        done
        
        echo "‚ùå Rollback verification failed"
        echo "Last response code: $RESPONSE"
        exit 1
        EOF
        
        chmod +x rollback.sh
        echo "‚úÖ Rollback script created"
        
        # Â§çÂà∂ÂõûÊªöËÑöÊú¨Âà∞VM
        echo "Copying rollback script to VM..."
        sshpass -p "$VM_PASSWORD" scp \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=15 \
          rollback.sh \
          "$VM_USER@$VM_HOST:/opt/web-calculator/rollback.sh"
        
        # ËÆæÁΩÆÊùÉÈôê
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          "$VM_USER@$VM_HOST" \
          "chmod +x /opt/web-calculator/rollback.sh && \
           echo 'Rollback script available at: /opt/web-calculator/rollback.sh'"
        
        echo "‚úÖ Rollback script deployed to VM"

  notification:
    name: Send Notification
    needs: [test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Determine deployment status
      id: deployment-status
      run: |
        if ${{ needs.deploy.result == 'success' }}; then
          echo "STATUS=success" >> $GITHUB_OUTPUT
          echo "EMOJI=‚úÖ" >> $GITHUB_OUTPUT
          echo "MESSAGE=CI/CD Pipeline completed successfully!" >> $GITHUB_OUTPUT
        elif ${{ needs.deploy.result == 'failure' }}; then
          echo "STATUS=failure" >> $GITHUB_OUTPUT
          echo "EMOJI=‚ùå" >> $GITHUB_OUTPUT
          echo "MESSAGE=CI/CD Pipeline failed during deployment!" >> $GITHUB_OUTPUT
        elif ${{ needs.build.result == 'failure' }}; then
          echo "STATUS=failure" >> $GITHUB_OUTPUT
          echo "EMOJI=üö®" >> $GITHUB_OUTPUT
          echo "MESSAGE=CI/CD Pipeline failed during build!" >> $GITHUB_OUTPUT
        elif ${{ needs.test.result == 'failure' }}; then
          echo "STATUS=failure" >> $GITHUB_OUTPUT
          echo "EMOJI=‚ö†Ô∏è" >> $GITHUB_OUTPUT
          echo "MESSAGE=CI/CD Pipeline failed during tests!" >> $GITHUB_OUTPUT
        elif ${{ failure() }}; then
          echo "STATUS=failure" >> $GITHUB_OUTPUT
          echo "EMOJI=üí•" >> $GITHUB_OUTPUT
          echo "MESSAGE=CI/CD Pipeline failed!" >> $GITHUB_OUTPUT
        else
          echo "STATUS=success" >> $GITHUB_OUTPUT
          echo "EMOJI=‚úÖ" >> $GITHUB_OUTPUT
          echo "MESSAGE=CI/CD Pipeline completed!" >> $GITHUB_OUTPUT
        fi
    
    - name: Send success notification
      if: steps.deployment-status.outputs.STATUS == 'success'
      run: |
        echo "${{ steps.deployment-status.outputs.EMOJI }} ${{ steps.deployment-status.outputs.MESSAGE }}"
        echo "üìä Test Results:"
        echo "   - Branch: ${{ github.ref_name }}"
        echo "   - Commit: ${{ github.sha }}"
        echo "   - Actor: ${{ github.actor }}"
        echo "   - Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "üåê Deployment Details:"
        echo "   - URL: http://${{ secrets.VM_HOST || 'VM_IP_NOT_SET' }}"
        echo "   - Image: ${{ env.IMAGE_FULL_NAME }}"
        echo "   - Tag: ${{ env.DEPLOY_TAG || 'N/A' }}"
        echo ""
        echo "üìã Rollback Instructions:"
        echo "   SSH to VM and run: /opt/web-calculator/rollback.sh"
    
    - name: Send failure notification
      if: steps.deployment-status.outputs.STATUS == 'failure'
      run: |
        echo "${{ steps.deployment-status.outputs.EMOJI }} ${{ steps.deployment-status.outputs.MESSAGE }}"
        echo ""
        echo "üîç Debug Information:"
        echo "   - Workflow: ${{ github.workflow }}"
        echo "   - Run ID: ${{ github.run_id }}"
        echo "   - Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "   - Commit: ${{ github.sha }}"
        echo "   - Branch: ${{ github.ref_name }}"
        echo ""
        echo "‚ö†Ô∏è Failed Jobs:"
        {{#each needs}}
        {{#if (eq this.result 'failure')}}
        echo "   - {{this.name}}"
        {{/if}}
        {{/each}}
        echo ""
        echo "üöÄ Manual Rollback (if deployment failed):"
        echo "   ssh ${{ secrets.VM_USER || 'ubuntu' }}@${{ secrets.VM_HOST }}"
        echo "   cd /opt/web-calculator"
        echo "   ./rollback.sh"
        
        # ÈÄÄÂá∫Â§±Ë¥•Áä∂ÊÄÅ
        exit 1