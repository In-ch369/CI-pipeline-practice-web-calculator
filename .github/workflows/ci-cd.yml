name: Web Calculator CI/CD

on:
  push:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        python -m pytest tests/ -v

  build:
    name: Build Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}
    
    - name: Build and push Docker image
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        IMAGE_NAME="ghcr.io/${{ github.repository }}:sha-$SHORT_SHA"
        
        docker build -t $IMAGE_NAME .
        docker push $IMAGE_NAME
        
        echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

  deploy:
    name: Deploy to Server
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Check network connectivity
      env:
        VM_HOST: ${{ secrets.VM_HOST }}
      run: |
        echo "检查服务器连通性..."
        echo "目标主机: $VM_HOST"
        
        if [ -z "$VM_HOST" ]; then
          echo "❌ 错误: VM_HOST 未设置"
          exit 1
        fi
        
        # 只检查最重要的端口22
        echo "测试SSH端口..."
        if timeout 5 nc -z -w 2 "$VM_HOST" 22; then
          echo "✅ 端口22可达"
        else
          echo "❌ 错误: 无法连接到 $VM_HOST:22"
          echo "请检查："
          echo "1. 服务器IP地址是否正确"
          echo "2. 服务器是否运行"
          echo "3. 22端口是否开放"
          exit 1
        fi
    
    - name: Install sshpass
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
    
    - name: Deploy using SSH
      env:
        VM_USER: ${{ secrets.VM_USER }}
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        IMAGE_NAME: ${{ env.IMAGE_NAME }}
      run: |
        echo "开始部署到 $VM_USER@$VM_HOST..."
        echo "镜像: $IMAGE_NAME"
        
        # 简单测试SSH连接
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          "$VM_USER@$VM_HOST" \
          "echo '✅ SSH连接成功'; whoami; hostname"
        
        # 部署命令
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          "$VM_USER@$VM_HOST" << 'EOF'
        set -e
        
        echo "开始部署..."
        
        # 登录到GitHub Container Registry
        echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
        
        # 拉取镜像
        echo "拉取镜像: $IMAGE_NAME"
        docker pull "$IMAGE_NAME" || { echo "镜像拉取失败"; exit 1; }
        
        # 停止并移除旧容器
        echo "停止旧容器..."
        docker stop web-calculator 2>/dev/null || true
        docker rm web-calculator 2>/dev/null || true
        
        # 运行新容器
        echo "启动新容器..."
        docker run -d \
          --name web-calculator \
          -p 5000:5000 \
          --restart always \
          "$IMAGE_NAME"
        
        echo "等待容器启动..."
        sleep 5
        
        # 验证部署
        if docker ps | grep -q "web-calculator"; then
          echo "✅ 部署成功！"
          echo "容器状态："
          docker ps | grep web-calculator
          echo ""
          echo "应用日志："
          docker logs --tail 10 web-calculator
        else
          echo "❌ 部署失败"
          docker logs web-calculator
          exit 1
        fi
        EOF